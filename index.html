<!DOCTYPE html>
<html lang="ja">
<head>
    <meta property="og:title" content="ガチのマジでマークダウンをレンダリングするだけのサイト">
    <meta property="og:description" content="ブラウザ上でMarkdownをリアルタイムプレビュー＆HTML変換できるシンプルなツール。ダークモード対応、完全ローカル動作。">
    <meta property="og:url" content="https://md.locknpackn.dev/">
    <meta property="og:image" content="https://md.locknpackn.dev/ogp.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="LocknPackn Tools">
    <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@yoshiteru11600"> <meta name="twitter:creator" content="@yoshiteru11600">
    <meta name="twitter:title" content="ガチのマジでマークダウンをレンダリングするだけのサイト">
    <meta name="twitter:description" content="ブラウザ上でMarkdownをリアルタイムプレビュー＆HTML変換できるシンプルなツール。">
    <meta name="twitter:image" content="https://md.locknpackn.dev/ogp.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガチのマジでマークダウンをレンダリングするだけのサイト</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style id="app-style">
        :root {
            --main-font: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --header-bg: #333;
            --header-text: #fff;
            --area-bg: #ffffff;
            --border-color: #ddd;
            --primary-color: #2980b9;
            --accent-color: #27ae60;
            --secondary-color: #7f8c8d;
            --download-color: #8e44ad;
            --tool-save-color: #e67e22;
            --quote-color: #666;
            --quote-border: #ddd;
            --hash-color: #bbb; 
            --active-color: #f39c12;
            --active-text: #fff;
            --resizer-bg: #ccc;
            --credit-btn-bg: #34495e;
            --btn-inactive-bg: #555;
            --btn-inactive-text: #ccc;
            --disabled-opacity: 0.4;
        }

        [data-theme="dark"] {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #000;
            --header-text: #eee;
            --area-bg: #2d2d2d;
            --border-color: #444;
            --primary-color: #3498db;
            --accent-color: #2ecc71;
            --secondary-color: #95a5a6;
            --download-color: #9b59b6;
            --tool-save-color: #d35400;
            --quote-color: #aaa;
            --quote-border: #555;
            --hash-color: #666;
            --resizer-bg: #555;
            --credit-btn-bg: #2c3e50;
            --btn-inactive-bg: #333;
            --btn-inactive-text: #888;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--main-font);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            width: 100%;
            padding: 0 1.5rem;
            background: var(--header-bg);
            color: var(--header-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            height: 60px;
            position: relative;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }

        .title-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
            margin-right: 20px;
            flex: 1;
            overflow: hidden;
        }

        h1 {
            margin: 0;
            font-size: 1.0rem;
            font-weight: normal;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .version { font-size: 0.75em; color: #aaa; margin-left: 5px; }

        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button.header-btn {
            border: 1px solid #555;
            padding: 0 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
            color: #fff;
            background-color: #444;
            display: inline-flex;
            align-items: center;
            height: 30px;
            justify-content: center;
            font-weight: normal;
            transition: all 0.2s;
        }
        button.header-btn:hover { filter: brightness(1.1); }
        
        button.header-btn:disabled {
            opacity: var(--disabled-opacity);
            cursor: default;
            filter: none;
            background-color: #444 !important;
            color: #aaa !important;
        }

        .btn-copy { background-color: var(--accent-color) !important; border-color: var(--accent-color) !important; }
        .btn-export { background-color: var(--download-color) !important; border-color: var(--download-color) !important; }
        .btn-tool { background-color: var(--tool-save-color) !important; border-color: var(--tool-save-color) !important; }
        .btn-credit { background-color: var(--credit-btn-bg) !important; border-color: var(--credit-btn-bg) !important; margin-left: 15px; }

        button.header-btn.active {
            background-color: var(--active-color) !important;
            border-color: var(--active-color) !important;
            color: var(--active-text) !important;
            font-weight: bold;
            opacity: 1 !important;
        }

        .control-group {
            display: flex; align-items: center; background-color: var(--btn-inactive-bg);
            border-radius: 4px; overflow: hidden; border: 1px solid #555; height: 30px;
        }
        .control-label {
            font-size: 0.75rem; padding: 0 8px; color: #ccc; background-color: #222;
            height: 100%; display: flex; align-items: center; border-right: 1px solid #555;
        }
        .control-btn {
            border: none; background: transparent; color: var(--btn-inactive-text);
            padding: 0 10px; cursor: pointer; font-size: 0.75rem; height: 100%;
            transition: background 0.2s, color 0.2s;
        }
        .control-btn.active {
            background-color: var(--active-color) !important; 
            color: var(--active-text) !important; 
            font-weight: bold !important;
        }
        .control-btn:not(:last-child) { border-right: 1px solid #555; }

        .horizontal-controls { display: flex; gap: 8px; align-items: center; }
        .horizontal-controls.hidden { display: none !important; }

        .hamburger-btn {
            display: none; background: none; border: none; color: var(--header-text);
            font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px;
            justify-content: center; align-items: center;
        }

        /* --- Main Layout --- */
        main {
            width: 100%; margin: 0; padding: 0; display: flex; flex-direction: column;
            gap: 0; flex-grow: 1; overflow-y: auto; position: relative;
        }

        /* Vertical Layout */
        .editor-container { width: 100%; padding: 0 20px; box-sizing: border-box; }
        .preview-container { width: 100%; padding: 0 20px 50px 20px; box-sizing: border-box; }

        .action-bar {
            display: flex; justify-content: flex-end; gap: 10px; padding: 8px 20px;
            background-color: var(--bg-color); border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 20;
        }
        .preview-bar {
            display: flex; justify-content: flex-end; padding: 8px 20px;
            border-top: 1px solid var(--border-color); background-color: var(--bg-color);
            position: sticky; top: 0; z-index: 20;
        }

        /* Horizontal Layout */
        main.layout-horizontal { 
            flex-direction: row; 
            overflow: hidden; 
            flex-wrap: nowrap;
        }
        main.layout-horizontal .editor-container { 
            height: 100%; overflow: hidden; padding: 0; border-right: none; 
            flex-shrink: 0;
        }
        main.layout-horizontal .preview-container { 
            height: 100%; overflow-y: auto; padding: 0 20px; margin-bottom: 0; 
            flex-shrink: 0;
        }
        main.layout-horizontal .action-bar { display: none !important; }
        main.layout-horizontal .preview-bar { display: none !important; }

        /* Resizer */
        #resizer {
            display: none; width: 10px; background-color: var(--bg-color); cursor: col-resize;
            height: 100%; z-index: 10; flex-shrink: 0; align-items: center; justify-content: center;
            border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color);
        }
        #resizer::after { content: "||"; color: var(--secondary-color); font-size: 10px; pointer-events: none; }
        main.layout-horizontal #resizer { display: flex; }
        
        main.preview-hidden .editor-container { width: 100% !important; flex-basis: auto !important; }
        main.preview-hidden #resizer, main.preview-hidden .preview-container { display: none !important; }
        main.preview-hidden .action-bar #btn-goto-preview { display: none; }

        textarea#markdown-input {
            width: 100%; min-height: 60vh; height: auto; padding: 10px; border: none;
            background-color: var(--area-bg); color: var(--text-color); font-family: inherit;
            font-size: 16px; line-height: 1.6; resize: vertical; outline: none; tab-size: 4; display: block;
        }
        main.layout-horizontal textarea#markdown-input { height: 100%; resize: none; overflow-y: auto; padding: 20px; }

        #markdown-output {
            width: 100%; min-height: 300px; background-color: var(--area-bg); color: var(--text-color);
            line-height: 1.8; font-family: inherit; padding: 10px;
            display: block;
        }
        main.layout-horizontal #markdown-output { min-height: auto; background-color: transparent; padding-top: 20px; }

        /* Markdown Styles */
        #markdown-output h1 { font-size: 2.0em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin-top: 0.5em; }
        #markdown-output h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin-top: 1.5em; }
        #markdown-output blockquote { border-left: 4px solid var(--quote-border); color: var(--quote-color); padding-left: 1em; margin-left: 0; }
        #markdown-output :not(pre) > code { background-color: rgba(175, 184, 193, 0.2); padding: 2px 4px; border-radius: 3px; font-family: "Consolas", "Monaco", monospace; color: #eb5757; }
        [data-theme="dark"] #markdown-output :not(pre) > code { background-color: rgba(110, 118, 129, 0.4); color: #ff7b72; }
        #markdown-output pre { border-radius: 6px; overflow: auto; }
        #markdown-output pre code { font-family: "Consolas", "Monaco", monospace; padding: 16px; display: block; background-color: #282c34; color: #abb2bf; }
        .mermaid { background-color: transparent; margin: 20px auto; text-align: center; }
        #markdown-output img { max-width: 100%; }
        #markdown-output table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        #markdown-output th, #markdown-output td { border: 1px solid var(--border-color); padding: 8px; }
        #markdown-output th { background-color: rgba(0,0,0,0.05); }
        [data-theme="dark"] #markdown-output th { background-color: rgba(255,255,255,0.05); }
        #markdown-output a { color: var(--primary-color); }

        .show-hashes h1::before { content: "# "; color: var(--hash-color); font-family: monospace; }
        .show-hashes h2::before { content: "## "; color: var(--hash-color); font-family: monospace; }
        .show-hashes h3::before { content: "### "; color: var(--hash-color); font-family: monospace; }
        .show-hashes h4::before { content: "#### "; color: var(--hash-color); font-family: monospace; }
        .show-hashes h5::before { content: "##### "; color: var(--hash-color); font-family: monospace; }
        .show-hashes h6::before { content: "###### "; color: var(--hash-color); font-family: monospace; }

        .btn-primary { background-color: var(--primary-color); color: white; border: none; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.8rem;}
        .btn-secondary { background-color: var(--secondary-color); color: white; border: none; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.8rem;}

        /* Modals */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--area-bg); color: var(--text-color); padding: 25px;
            border-radius: 8px; width: 90%; max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: relative;
            max-height: 90vh; overflow-y: auto; opacity: 0;
        }
        .tremble { animation: shakeFadeIn 0.3s ease-out forwards; }
        @keyframes shakeFadeIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1.0); } }
        .modal-header { font-size: 1.2em; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .modal-close-hint { text-align: center; margin-top: 20px; font-size: 0.8em; color: var(--secondary-color); cursor: pointer; }

        .setting-row { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .setting-row label { font-weight: bold; }
        
        .font-list { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .font-option {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .font-option:hover { background-color: rgba(0,0,0,0.05); }
        .font-option.active { border-color: var(--active-color); background-color: rgba(243, 156, 18, 0.1); }
        .font-check { color: var(--active-color); visibility: hidden; }
        .font-option.active .font-check { visibility: visible; }

        #credit-content ul { list-style: none; padding: 0; }
        #credit-content li { margin-bottom: 5px; }
        #credit-content a { color: var(--primary-color); text-decoration: none; }
        #credit-content a:hover { text-decoration: underline; }

        textarea.css-editor {
            width: 100%; height: 150px; background: #333; color: #fff; font-family: monospace; 
            padding: 10px; border-radius: 4px; border: 1px solid #555;
        }

        @media (max-width: 1100px) {
            .title-wrapper h1 { font-size: 0.9rem; }
            .header-controls { gap: 5px; }
            .control-label { display: none; }
        }

        @media (max-width: 900px) {
            .hamburger-btn { display: flex; }
            .header-controls {
                display: none; position: absolute; top: 60px; right: 0; background-color: var(--header-bg);
                width: 100%; padding: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.3);
                grid-template-columns: 1fr 1fr; gap: 15px; max-height: 80vh; overflow-y: auto;
            }
            .header-controls.show-menu { display: grid; }
            button.header-btn, .header-controls select, .control-group {
                height: 55px !important; width: 100%; font-size: 1rem !important; margin: 0;
            }
            .control-btn { font-size: 1rem !important; flex: 1; }
            .control-label { font-size: 0.9rem; display: flex; padding: 0 10px; }
            .control-group, #btn-save-tool { grid-column: 1 / -1; }
            .horizontal-controls { display: none !important; }
            .btn-credit { margin-left: 0; }
            .setting-row { flexDirection: column; alignItems: flex-start; }
            .setting-row label { marginBottom: 8px; width: 100%;}
            .setting-row .control-group { width: 100%; }
            
            main.layout-horizontal { flexDirection: column !important; width: 100% !important; padding: 0 !important; overflow-y: auto !important; }
            main.layout-horizontal .editor-container, main.layout-horizontal .preview-container { width: 100% !important; height: auto !important; padding: 0 20px !important; overflow-y: visible !important; }
            #resizer { display: none !important; }
            main.layout-horizontal textarea#markdown-input { height: 60vh !important; overflow-y: auto !important; padding: 20px 0 !important; }
            main.layout-horizontal .action-bar { display: flex !important; }
            main.layout-horizontal .preview-bar { display: flex !important; }
        }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 17px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
    <style id="custom-css"></style>
</head>
<body>

    <header>
        <div class="title-wrapper">
            <h1 id="app-title">ガチのマジでマークダウンをレンダリングするだけのサイト <span class="version">v1.0.6.3</span></h1>
        </div>
        
        <button class="hamburger-btn" id="hamburger-btn">☰</button>

        <div class="header-controls" id="header-controls">
            <button id="btn-copy" class="header-btn btn-copy" data-i18n="copy_btn">クリップボードへコピー</button>
            <button id="btn-download" class="header-btn btn-export" data-i18n="save_md">.mdへ書き出し</button>
            <button id="btn-save-tool" class="header-btn btn-tool" data-i18n="save_html">このツールをダウンロード</button>

            <div class="control-group">
                <span class="control-label" data-i18n="lbl_layout">表示形式</span>
                <button class="control-btn" id="layout-h" data-val="horizontal" data-i18n="layout_h">左右</button>
                <button class="control-btn" id="layout-v" data-val="vertical" data-i18n="layout_v">上下</button>
            </div>

            <div class="horizontal-controls" id="h-controls">
                <div class="control-group">
                    <span class="control-label" data-i18n="lbl_sync">スクロール同期</span>
                    <button class="control-btn" id="sync-on" data-val="true">ON</button>
                    <button class="control-btn" id="sync-off" data-val="false">OFF</button>
                </div>
                <div class="control-group">
                    <span class="control-label" data-i18n="lbl_preview">プレビュー表示</span>
                    <button class="control-btn" id="preview-on" data-val="true">ON</button>
                    <button class="control-btn" id="preview-off" data-val="false">OFF</button>
                </div>
                <button id="btn-reset-split" class="header-btn" data-i18n="btn_reset">中央揃え</button>
            </div>

            <button id="btn-settings" class="header-btn" data-i18n="btn_settings">設定</button>
            <button id="btn-credit" class="header-btn btn-credit" data-i18n="btn_credit">クレジット</button>
        </div>
    </header>

    <main id="main-container">
        <div class="editor-container">
            <div class="action-bar" id="editor-action-bar">
                <button id="btn-goto-preview" class="btn-primary" data-i18n="goto_preview">プレビュー ↓</button>
            </div>
            <textarea id="markdown-input" placeholder="# Markdown Editor"></textarea>
        </div>
        <div id="preview-anchor"></div>
        <div id="resizer"></div>

        <div class="preview-container">
            <div class="preview-bar">
                <button id="btn-goto-input" class="btn-secondary" data-i18n="goto_input">↑ 入力に戻る</button>
            </div>

            <div id="markdown-output">
                <p style="color: var(--secondary-color);" data-i18n="preview_area">(プレビューエリア)</p>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header" data-i18n="settings_title">設定</div>
            
            <div class="setting-row">
                <label data-i18n="lbl_theme">テーマ</label>
                <div class="control-group">
                    <button class="control-btn" id="theme-dark" data-val="dark" data-i18n="theme_dark">ダーク</button>
                    <button class="control-btn" id="theme-light" data-val="light" data-i18n="theme_light">ライト</button>
                </div>
            </div>

            <div class="setting-row">
                <label data-i18n="lbl_hash">＃見出し</label>
                <div class="control-group">
                    <button class="control-btn" id="hash-show" data-val="true" data-i18n="hash_show">表示</button>
                    <button class="control-btn" id="hash-hide" data-val="false" data-i18n="hash_hide">非表示</button>
                </div>
            </div>

            <div class="setting-row">
                <label data-i18n="lbl_lang">言語</label>
                <div class="control-group">
                    <button class="control-btn" id="lang-ja" data-val="ja">日本語</button>
                    <button class="control-btn" id="lang-en" data-val="en">English</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 15px 0;">

            <label style="font-weight:bold;" data-i18n="lbl_font">フォント</label>
            <div class="font-list" id="font-list"></div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 15px 0;">

            <label style="font-weight:bold; display:block; margin-bottom:5px;">Custom CSS</label>
            <textarea id="custom-css-input" class="css-editor"></textarea>
            <button id="btn-save-css" class="btn-primary" style="width:100%; margin-top:5px;" data-i18n="save_settings">設定を保存</button>

            <div class="modal-close-hint" data-i18n="close_hint">背景をクリックして閉じる</div>
        </div>
    </div>

    <div class="modal-overlay" id="credit-modal">
        <div class="modal-content">
            <div class="modal-header" data-i18n="btn_credit">クレジット</div>
            <div id="credit-content">
                <p><span data-i18n="author">作者</span>: <a href="https://x.com/yoshiteru11600" target="_blank">@yoshiteru11600</a></p>
                <p><span>Github</span>: <a href="https://github.com/Yoshiteru11600/gachi-markdown?tab=readme-ov-file#readme" target="_blank">gachi-markdown</a></p>
                <hr style="margin: 15px 0; border:0; border-top:1px solid #ddd;">
                <p style="font-weight:bold;">Libraries</p>
                <ul>
                    <li>Marked.js (MIT)</li>
                    <li>Highlight.js (BSD 3-Clause)</li>
                    <li>Mermaid.js (MIT)</li>
                    <li>smol-toml (MIT)</li>
                </ul>
            </div>
            <div class="modal-close-hint" data-i18n="close_hint">背景をクリックして閉じる</div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- Config & Data ---
        const KEYS = { TEXT: 'gachi_md_content', CONFIG: 'gachi_md_config_v6' };
        
        const defaultConfig = {
            theme: 'light', layout: 'vertical', sync: true, preview: true,
            split: 50, hash: false, lang: 'ja', font: 'std', css: ''
        };
        let config = { ...defaultConfig };

        const fonts = [
            { id: 'std', label: '標準 (Standard)', style: '"Helvetica Neue", Arial, sans-serif' },
            { id: 'mincho', label: '明朝体 (Mincho)', style: '"Yu Mincho", "Hiragino Mincho ProN", serif' },
            { id: 'mono', label: '等幅 (Monospace)', style: '"Consolas", "Monaco", monospace' },
            { id: 'hand', label: '手書き (Handwriting)', style: '"Comic Sans MS", "Chalkboard SE", sans-serif' }
        ];

        const i18n = {
            ja: {
                copy_btn: "クリップボードへコピー", save_md: ".mdへ書き出し", save_html: "このツールをダウンロード",
                lbl_layout: "表示形式", layout_h: "左右", layout_v: "上下",
                lbl_sync: "スクロール同期", lbl_preview: "プレビュー表示",
                btn_reset: "中央揃え", btn_settings: "設定", btn_credit: "クレジット",
                goto_preview: "プレビュー ↓", goto_input: "↑ 入力に戻る", preview_area: "(プレビューエリア)",
                settings_title: "設定",
                lbl_theme: "テーマ", theme_dark: "ダーク", theme_light: "ライト",
                lbl_hash: "＃見出し", hash_show: "表示", hash_hide: "非表示",
                lbl_lang: "言語", lbl_font: "フォント", save_settings: "設定を保存",
                close_hint: "背景をクリックして閉じる", author: "作者",
                toast_copy: "コピーしました", toast_fail: "失敗しました", toast_saved: "保存しました",
                ph_input: "# Markdownを入力...",
            },
            en: {
                copy_btn: "Copy to Clipboard", save_md: "Export .md", save_html: "Download Tool",
                lbl_layout: "Layout", layout_h: "Split", layout_v: "Vert",
                lbl_sync: "Sync Scroll", lbl_preview: "Preview",
                btn_reset: "Center", btn_settings: "Settings", btn_credit: "Credit",
                goto_preview: "Preview ↓", goto_input: "↑ Input", preview_area: "(Preview Area)",
                settings_title: "Settings",
                lbl_theme: "Theme", theme_dark: "Dark", theme_light: "Light",
                lbl_hash: "Headings #", hash_show: "Show", hash_hide: "Hide",
                lbl_lang: "Language", lbl_font: "Font", save_settings: "Save Settings",
                close_hint: "Click background to close", author: "Author",
                toast_copy: "Copied!", toast_fail: "Failed", toast_saved: "Saved",
                ph_input: "# Enter Markdown...",
            }
        };

        // Globals
        let els = {};
        const $ = (id) => document.getElementById(id);
        const qs = (sel) => document.querySelector(sel);

        // --- Utility: Debounce ---
        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        // --- Functions ---
        const loadConfig = () => {
            const saved = localStorage.getItem(KEYS.CONFIG);
            if (saved) { try { config = { ...defaultConfig, ...JSON.parse(saved) }; } catch(e){} }
        };
        const saveConfig = () => localStorage.setItem(KEYS.CONFIG, JSON.stringify(config));

        const updateLang = () => {
            const t = i18n[config.lang];
            document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t[el.dataset.i18n]; });
            $('app-title').innerHTML = `ガチのマジでマークダウンをレンダリングするだけのサイト <span class="version">v1.0.6.3</span>`;
            updateToggleGroup('lang', config.lang);
        };

        const updateTheme = () => {
            document.documentElement.setAttribute('data-theme', config.theme);
            updateToggleGroup('theme', config.theme);
            renderMarkdown(); 
        };

        const updateLayout = () => {
            if (config.layout === 'horizontal') {
                els.main.classList.add('layout-horizontal');
                els.hControls.classList.remove('hidden');
                setSplit(config.split);
            } else {
                els.main.classList.remove('layout-horizontal');
                els.hControls.classList.add('hidden');
                els.editor.style.width = '';
                els.preview.style.width = '';
            }
            updateToggleGroup('layout', config.layout);
        };

        const updateCenterButton = () => {
            const isCentered = Math.abs(config.split - 50) < 0.1;
            els.btnReset.disabled = isCentered;
            if (isCentered) els.btnReset.classList.remove('active');
            else els.btnReset.classList.add('active');
        };

        const setSplit = (val) => {
            if (val < 10) val = 10; if (val > 90) val = 90;
            config.split = val;
            if (config.layout === 'horizontal') {
                // 10px is resizer width. Split space: 5px left, 5px right
                els.editor.style.width = `calc(${val}% - 5px)`;
                els.preview.style.width = `calc(${100 - val}% - 5px)`;
            }
            updateCenterButton();
        };

        const updateSync = () => updateToggleGroup('sync', config.sync ? 'true' : 'false');
        
        const updatePreview = () => {
            if (config.preview) {
                els.main.classList.remove('preview-hidden');
                renderMarkdown();
            } else {
                els.main.classList.add('preview-hidden');
            }
            updateToggleGroup('preview', config.preview ? 'true' : 'false');
        };

        const updateHash = () => {
            config.hash ? els.output.classList.add('show-hashes') : els.output.classList.remove('show-hashes');
            updateToggleGroup('hash', config.hash ? 'true' : 'false');
        };

        const updateFont = () => {
            const f = fonts.find(x => x.id === config.font) || fonts[0];
            document.documentElement.style.setProperty('--main-font', f.style);
            renderFontList();
        };

        const updateToggleGroup = (prefix, activeVal) => {
            document.querySelectorAll(`[id^="${prefix}-"]`).forEach(btn => {
                if (String(btn.dataset.val) === String(activeVal)) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        };

        const renderFontList = () => {
            const container = els.fontList;
            if(!container) return;
            container.innerHTML = '';
            fonts.forEach(f => {
                const div = document.createElement('div');
                div.className = `font-option ${config.font === f.id ? 'active' : ''}`;
                div.style.fontFamily = f.style;
                div.innerHTML = `<span>${f.label}</span><span class="font-check">✔</span>`;
                div.onclick = () => { config.font = f.id; updateFont(); saveConfig(); };
                container.appendChild(div);
            });
        };

        const toggleModal = (name, show) => {
            const m = els.modals[name];
            m.style.display = show ? 'flex' : 'none';
            if (show) {
                const c = m.querySelector('.modal-content');
                c.classList.remove('tremble');
                void c.offsetWidth; c.classList.add('tremble');
            }
        };

        const showToast = (msg) => {
            const t = els.toast; t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const downloadBlob = (blob, name) => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        // --- Core Rendering (Debounced) ---
        const renderMarkdown = () => {
            if (!config.preview) return;
            
            try {
                if (typeof marked !== 'undefined') {
                    marked.use({ breaks: true, gfm: true });
                    els.output.innerHTML = marked.parse(els.input.value);
                } else {
                    els.output.innerHTML = "<pre>" + els.input.value + "</pre>";
                }
            } catch (e) {
                console.error("Render Error:", e);
                return;
            }

            if (typeof hljs !== 'undefined') {
                els.output.querySelectorAll('pre code').forEach(block => {
                    if (!block.classList.contains('language-mermaid')) {
                        hljs.highlightElement(block);
                    }
                });
            }

            if (typeof mermaid !== 'undefined') {
                const mermaidBlocks = els.output.querySelectorAll('pre code.language-mermaid');
                if (mermaidBlocks.length > 0) {
                    mermaidBlocks.forEach((block, index) => {
                        const pre = block.parentElement;
                        const div = document.createElement('div');
                        div.className = 'mermaid';
                        div.textContent = block.textContent;
                        div.id = 'mermaid-' + index;
                        pre.replaceWith(div);
                    });
                    
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    try {
                        mermaid.initialize({ startOnLoad: false, theme: isDark ? 'dark' : 'default' });
                        mermaid.run({ nodes: els.output.querySelectorAll('.mermaid') });
                    } catch (e) { console.warn("Mermaid Error", e); }
                }
            }
        };

        // Debounced version for typing
        const debouncedRender = debounce(renderMarkdown, 300);

        // --- Scroll Sync ---
        let scrollSource = null;
        const doSync = (src) => {
            if (!config.sync || config.layout !== 'horizontal') return;
            if (scrollSource && scrollSource !== src) return;
            const s = src === 'editor' ? els.input : els.output.parentElement;
            const t = src === 'editor' ? els.output.parentElement : els.input;
            const pct = s.scrollTop / (s.scrollHeight - s.clientHeight);
            if (!isNaN(pct)) t.scrollTop = pct * (t.scrollHeight - t.clientHeight);
        };

        // --- Resize Logic (RAF) ---
        let isResizing = false;
        let animationFrameId = null;
        
        const onMouseMove = (e) => {
            if (!isResizing || config.layout !== 'horizontal') return;
            if (animationFrameId) return; // Throttle

            animationFrameId = requestAnimationFrame(() => {
                const rect = els.main.getBoundingClientRect();
                const val = ((e.clientX - rect.left) / els.main.offsetWidth) * 100;
                setSplit(val);
                animationFrameId = null;
            });
        };
        
        const onMouseUp = () => { if(isResizing) { isResizing = false; saveConfig(); } };

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            els = {
                main: $('main-container'),
                input: $('markdown-input'),
                output: $('markdown-output'),
                resizer: $('resizer'),
                hControls: $('h-controls'),
                fontList: $('font-list'),
                modals: { settings: $('settings-modal'), credit: $('credit-modal') },
                toast: $('toast'),
                btnReset: $('btn-reset-split'),
                editor: qs('.editor-container'),
                preview: qs('.preview-container')
            };

            loadConfig();
            const txt = localStorage.getItem(KEYS.TEXT);
            if (txt) els.input.value = txt; else els.input.value = "";

            updateLang();
            updateTheme();
            updateLayout();
            updateSync();
            updatePreview();
            updateHash();
            updateFont();

            if (config.css) {
                $('custom-css').textContent = config.css;
                $('custom-css-input').value = config.css;
            }

            // Listeners
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.id;
                    const val = e.target.dataset.val;
                    if (id.startsWith('layout')) { config.layout = val; updateLayout(); }
                    if (id.startsWith('sync')) { config.sync = (val === 'true'); updateSync(); }
                    if (id.startsWith('preview')) { config.preview = (val === 'true'); updatePreview(); }
                    if (id.startsWith('theme')) { config.theme = val; updateTheme(); }
                    if (id.startsWith('hash')) { config.hash = (val === 'true'); updateHash(); }
                    if (id.startsWith('lang')) { config.lang = val; updateLang(); }
                    saveConfig();
                });
            });

            els.btnReset.onclick = () => { setSplit(50); saveConfig(); };
            $('btn-settings').onclick = () => toggleModal('settings', true);
            $('btn-credit').onclick = () => toggleModal('credit', true);
            $('btn-copy').onclick = async () => {
                try { await navigator.clipboard.writeText(els.input.value); showToast(i18n[config.lang].toast_copy); }
                catch(e) { showToast(i18n[config.lang].toast_fail); }
            };
            $('btn-download').onclick = () => {
                const blob = new Blob([els.input.value], { type: 'text/markdown' });
                downloadBlob(blob, 'document.md');
            };
            $('btn-save-tool').onclick = () => {
                const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
                const blob = new Blob([html], { type: 'text/html' });
                downloadBlob(blob, 'gachi-editor.html');
            };
            $('btn-save-css').onclick = () => {
                config.css = $('custom-css-input').value;
                $('custom-css').textContent = config.css;
                saveConfig();
                showToast(i18n[config.lang].toast_saved);
            };
            $('hamburger-btn').onclick = () => $('header-controls').classList.toggle('show-menu');
            $('btn-goto-preview').onclick = () => document.getElementById('preview-anchor').scrollIntoView({ behavior: 'smooth' });
            $('btn-goto-input').onclick = () => { els.main.scrollTo({ top: 0, behavior: 'smooth' }); setTimeout(() => els.input.focus(), 500); };

            Object.values(els.modals).forEach(m => m.onclick = e => { if(e.target===m) m.style.display='none'; });
            document.querySelectorAll('.modal-close-hint').forEach(el => el.onclick = e => e.target.closest('.modal-overlay').style.display='none');

            // Input Event: Save instantly, Render delayed
            els.input.addEventListener('input', () => {
                localStorage.setItem(KEYS.TEXT, els.input.value);
                debouncedRender(); // Use Debounce
            });

            els.input.onscroll = () => doSync('editor');
            els.output.parentElement.onscroll = () => doSync('preview');
            els.input.onmouseover = () => scrollSource = 'editor';
            els.output.parentElement.onmouseover = () => scrollSource = 'preview';

            els.resizer.onmousedown = (e) => { isResizing = true; e.preventDefault(); };
            document.addEventListener('mousemove', onMouseMove); // Use RAF
            document.addEventListener('mouseup', onMouseUp);

            els.input.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); $('btn-copy').click(); return; }
                if (e.key === 'Tab') { 
                    e.preventDefault(); 
                    els.input.setRangeText('    ', els.input.selectionStart, els.input.selectionEnd, 'end'); 
                    localStorage.setItem(KEYS.TEXT, els.input.value);
                    debouncedRender();
                }
            });
            document.addEventListener('keydown', (e) => {
                 if ((e.ctrlKey || e.metaKey) && e.key === 's' && document.activeElement !== els.input) { e.preventDefault(); $('btn-copy').click(); }
            });

            // Initial Render (Immediate)
            setTimeout(renderMarkdown, 100);
        });
    </script>
</body>
</html>